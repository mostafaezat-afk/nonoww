<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>حجز موعد طبي</title>
  <style>
    /* استيراد كامل التنسيقات الأصلية من الملف المرفق (مثل :root وتعريف الألوان، الخطوط، الحجوم، الأنيميشن...) */
    :root {
      --primary: #0d7ea2;
      --primary-light: #1094c0;
      --primary-dark: #085a77;
      --secondary: #00bfa5;
      --accent: #ff6b6b;
      --success: #26c281;
      --background: #f5f8fa;
      --card-bg: #ffffff;
      --text-primary: #1a1a2e;
      --text-secondary: #6c757d;
      --border: #e1e8ed;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }
    h1, h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 1.25rem;
    }
    /* قالب المراحل */
    .step {
      max-width: 480px;
      margin: 3rem auto 4rem;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 92, 133, 0.18);
      padding: 3rem 2rem 3rem 2rem;
      display: none;
      transition: opacity 0.3s ease;
    }
    .step.active {
      display: block;
      opacity: 1;
    }
    label {
      display: block;
      margin-bottom: 0.6rem;
      font-weight: 600;
      font-size: 1.6rem;
      color: var(--text-primary);
    }
    select, input[type="text"], input[type="tel"] {
      width: 100%;
      padding: 1.2rem 1.5rem;
      font-size: 1.6rem;
      border: 3px solid var(--border);
      border-radius: 24px;
      font-family: inherit;
      background: var(--background);
      color: var(--text-primary);
      margin-bottom: 2rem;
      transition: all 0.3s ease;
    }
    select:focus, input:focus {
      border-color: var(--primary);
      background: white;
      outline: none;
      box-shadow: 0 0 0 6px rgba(13, 126, 162, 0.2);
    }
    button {
      display: inline-block;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: none;
      border-radius: 24px;
      color: white;
      font-size: 1.8rem;
      font-weight: 700;
      padding: 1.4rem 3.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      font-family: 'Cairo', sans-serif;
      margin-right: 1rem;
      margin-bottom: 1rem;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(13, 126, 162, 0.45);
    }
    #daysContainer, #timesContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 1.2rem;
      margin-bottom: 2rem;
    }
    #daysContainer button, #timesContainer button {
      background: var(--secondary);
      padding: 1rem;
      font-size: 2rem;
      font-weight: 700;
      color: white;
      border-radius: 24px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
    }
    #daysContainer button.selected, #timesContainer button.selected {
      background: var(--success);
      box-shadow: 0 12px 40px rgba(38, 194, 129, 0.45);
      color: white;
      transform: translateY(-3px);
    }
    #message {
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--accent);
      text-align: center;
      margin-top: 1rem;
      min-height: 2.5rem;
    }
  </style>
</head>
<body>

<h1>نظام حجز المواعيد الطبية</h1>

<!-- المرحلة 1 -->
<div class="step active" id="step1">
  <h2>الخطوة 1: اختر الطبيب وأدخل بياناتك</h2>
  <label for="selectDoctor">اختر الطبيب</label>
  <select id="selectDoctor" required>
    <option value="">-- اختر الطبيب --</option>
  </select>

  <label for="inputName">الاسم</label>
  <input type="text" id="inputName" placeholder="أدخل اسمك" required autocomplete="off" />

  <label for="inputPhone">رقم الهاتف</label>
  <input type="tel" id="inputPhone" placeholder="أدخل رقم هاتفك" required autocomplete="off" />

  <button id="toStep2Btn">التالي</button>
</div>

<!-- المرحلة 2 -->
<div class="step" id="step2">
  <h2>الخطوة 2: اختر اليوم والموعد</h2>

  <label>اختر اليوم:</label>
  <div id="daysContainer">جارٍ التحميل...</div>

  <label>اختر الوقت:</label>
  <div id="timesContainer">يُرجى اختيار اليوم أولاً</div>

  <div style="text-align:center;">
    <button id="backToStep1Btn">السابق</button>
    <button id="confirmBookingBtn" disabled>تأكيد الحجز</button>
  </div>

  <div id="message"></div>
</div>

<script>
const BASE_URL = 'https://script.google.com/macros/s/AKfycbwSbETIi5LMZe8LTLSRDKxp8ovjOWGX3cWMYIj9kAInkps9G4qFH7hofhtn1o0fANf4/exec';

let selectedDoctor = null;
let selectedName = null;
let selectedPhone = null;
let selectedDay = null; // YYYY-MM-DD
let selectedTime = null; // HH:mm
let slotsByDate = {};

// جلب الأطباء عند تحميل الصفحة
async function loadDoctors() {
  try {
    const res = await fetch(BASE_URL + '?action=getDoctors');
    const doctors = await res.json();
    const select = document.getElementById('selectDoctor');
    doctors.forEach(doc => {
      let option = document.createElement('option');
      option.value = doc.name;
      option.textContent = doc.name;
      select.appendChild(option);
    });
  } catch(e) {
    alert('حدث خطأ أثناء تحميل قائمة الأطباء');
  }
}

// جلب المواعيد المتاحة للطبيب وتجميعها حسب الأيام
async function loadAvailableSlots(doctorName) {
  const daysContainer = document.getElementById('daysContainer');
  const timesContainer = document.getElementById('timesContainer');

  daysContainer.textContent = 'جارٍ تحميل المواعيد...';
  timesContainer.textContent = 'يُرجى اختيار اليوم أولاً';
  selectedDay = null;
  selectedTime = null;
  document.getElementById('confirmBookingBtn').disabled = true;

  try {
    const res = await fetch(BASE_URL + `?action=getAvailableSlotsForDoctor&doctorName=${encodeURIComponent(doctorName)}`);
    const slots = await res.json();

    if (!slots.length) {
      daysContainer.innerHTML = '<p style="text-align:center;color:#999;">لا توجد مواعيد متاحة حالياً.</p>';
      timesContainer.innerHTML = '';
      return;
    }

    slotsByDate = processSlots(slots);
    renderDays();
  } catch(e) {
    daysContainer.innerHTML = '<p style="text-align:center;color:#999;">خطأ في تحميل المواعيد.</p>';
    timesContainer.innerHTML = '';
  }
}

// تجميع المواعيد حسب الأيام
function processSlots(slotsArray) {
  let grouped = {};
  slotsArray.forEach(isoStr => {
    try {
      const date = new Date(isoStr);
      const dateKey = date.toISOString().split('T')[0];
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}`;
      if (!grouped[dateKey]) grouped[dateKey] = [];
      grouped[dateKey].push({ time: timeString, isoString: isoStr });
    } catch(e) {}
  });
  Object.keys(grouped).forEach(k => grouped[k].sort((a,b) => a.time.localeCompare(b.time)));
  return grouped;
}

// عرض الأيام المتاحة
function renderDays() {
  const daysContainer = document.getElementById('daysContainer');
  daysContainer.innerHTML = '';
  const dates = Object.keys(slotsByDate).sort();

  dates.forEach(dateStr => {
    const date = new Date(dateStr + 'T00:00:00');
    const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
    const dayNum = date.getDate();
    const monthName = date.toLocaleDateString('ar-EG', { month: 'long' });

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = `${dayName} ${dayNum} ${monthName}`;
    btn.onclick = () => selectDay(dateStr, btn);
    daysContainer.appendChild(btn);
  });

  document.getElementById('timesContainer').textContent = 'يُرجى اختيار اليوم أولاً';
}

// اختيار اليوم وعرض المواعيد المتاحة لذلك اليوم
function selectDay(dateStr, btn) {
  selectedDay = dateStr;
  selectedTime = null;
  document.getElementById('confirmBookingBtn').disabled = true;

  document.querySelectorAll('#daysContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  renderTimesForDay(dateStr);
}

// عرض المواعيد المتاحة لليوم المختار
function renderTimesForDay(dateStr) {
  const timesContainer = document.getElementById('timesContainer');
  timesContainer.innerHTML = '';
  const slots = slotsByDate[dateStr] || [];

  if (!slots.length) {
    timesContainer.innerHTML = '<p style="text-align:center;color:#999;">لا توجد أوقات متاحة</p>';
    return;
  }

  slots.forEach(slot => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = slot.time;
    btn.onclick = () => selectTime(slot.time, btn);
    timesContainer.appendChild(btn);
  });
}

// اختيار الموعد الزمني
function selectTime(time, btn) {
  selectedTime = time;
  document.getElementById('confirmBookingBtn').disabled = false;
  document.querySelectorAll('#timesContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

// الانتقال للمرحلة الثانية
document.getElementById('toStep2Btn').addEventListener('click', () => {
  const doctor = document.getElementById('selectDoctor').value;
  const name = document.getElementById('inputName').value.trim();
  const phone = document.getElementById('inputPhone').value.trim();

  if (!doctor) {
    alert('يرجى اختيار الطبيب');
    return;
  }
  if (!name) {
    alert('يرجى إدخال الاسم');
    return;
  }
  if (!phone) {
    alert('يرجى إدخال رقم الهاتف');
    return;
  }

  selectedDoctor = doctor;
  selectedName = name;
  selectedPhone = phone;

  document.getElementById('step1').classList.remove('active');
  document.getElementById('step2').classList.add('active');

  loadAvailableSlots(doctor);
});

// العودة للمرحلة الأولى
document.getElementById('backToStep1Btn').addEventListener('click', () => {
  document.getElementById('step2').classList.remove('active');
  document.getElementById('step1').classList.add('active');
});

// تأكيد الحجز وارساله للـ Google Apps Script
document.getElementById('confirmBookingBtn').addEventListener('click', async () => {
  if (!selectedTime || !selectedDay || !selectedDoctor || !selectedName || !selectedPhone) {
    alert('يرجى إكمال جميع البيانات واختيار الموعد');
    return;
  }

  const appointmentISO = `${selectedDay}T${selectedTime}:00`;

  const formData = new URLSearchParams();
  formData.append('action', 'bookAppointmentWithDoctor');
  formData.append('doctorName', selectedDoctor);
  formData.append('name', selectedName);
  formData.append('phone', selectedPhone);
  formData.append('appointmentTime', appointmentISO);

  try {
    const res = await fetch(BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData.toString()
    });
    const result = await res.json();
    if (result.success) {
      alert('تم الحجز بنجاح!');
      // إعادة تعيين القيم والعودة للخطوة الأولى
      selectedDoctor = null;
      selectedName = null;
      selectedPhone = null;
      selectedDay = null;
      selectedTime = null;
      slotsByDate = {};

      document.getElementById('selectDoctor').value = '';
      document.getElementById('inputName').value = '';
      document.getElementById('inputPhone').value = '';
      document.getElementById('daysContainer').innerHTML = '';
      document.getElementById('timesContainer').innerHTML = '';
      document.getElementById('confirmBookingBtn').disabled = true;

      document.getElementById('step2').classList.remove('active');
      document.getElementById('step1').classList.add('active');
    } else {
      alert('فشل الحجز: ' + (result.message || 'خطأ غير معروف'));
    }
  } catch (e) {
    alert('خطأ في الاتصال بالخادم');
  }
});

// تحميل الأطباء عند بداية الصفحة
loadDoctors();
</script>

</body>
</html>
