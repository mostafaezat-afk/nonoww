<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ</title>
  <base target="_top">
  <style>
    :root {
      --primary: #00B4D8;
      --primary-light: #48CAE4;
      --secondary: #90E0EF;
      --accent: #FF6B6B;
      --success: #06D6A0;
      --background: #CAF0F8;
      --card-bg: #FFFFFF;
      --text-primary: #023E8A;
      --text-secondary: #0077B6;
      --border: #ADE8F4;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #CAF0F8 0%, #90E0EF 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .medical-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      padding: 2rem 1rem;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 180, 216, 0.3);
      margin-bottom: 2rem;
    }
    
    .medical-header h1 {
      color: white;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .medical-icon {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 1rem 3rem;
    }
    
    .step {
      background: white;
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0, 180, 216, 0.15);
      padding: 2.5rem 2rem;
      display: none;
      border: 3px solid var(--border);
    }
    
    .step.active {
      display: block;
      animation: slideIn 0.4s ease;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 2rem;
      font-size: 1.8rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 600;
      font-size: 1.3rem;
      color: var(--text-secondary);
    }
    
    input[type="text"], input[type="tel"] {
      width: 100%;
      padding: 1.2rem;
      font-size: 1.4rem;
      border: 2px solid var(--border);
      border-radius: 16px;
      background: #E3F4F9;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }
    
    input:focus {
      border-color: var(--primary);
      background: white;
      outline: none;
      box-shadow: 0 0 0 4px rgba(0, 180, 216, 0.1);
    }
    
    #phoneError {
      color: var(--accent);
      display: none;
      padding: 0.5rem 1rem;
      background: #FFEBEE;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    #doctorsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    #doctorsContainer button {
      background: linear-gradient(135deg, var(--secondary), var(--primary-light));
      padding: 1.2rem 1rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      border-radius: 16px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 180, 216, 0.2);
    }
    
    #doctorsContainer button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 180, 216, 0.3);
    }
    
    #doctorsContainer button.selected {
      background: linear-gradient(135deg, var(--success), #4ADDB4);
      color: white;
      box-shadow: 0 8px 25px rgba(6, 214, 160, 0.4);
    }
    
    #daysContainer, #timesContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    #daysContainer button, #timesContainer button {
      background: linear-gradient(135deg, #B4E4F5, var(--secondary));
      padding: 1rem;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    #daysContainer button.selected, #timesContainer button.selected {
      background: linear-gradient(135deg, var(--success), #4ADDB4);
      color: white;
    }
    
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }
    
    button {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      padding: 1.2rem 2.5rem;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Cairo', sans-serif;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 180, 216, 0.3);
    }
    
    #backToStep1Btn {
      background: linear-gradient(135deg, #78909C, #90A4AE);
    }
    
    #confirmBookingBtn {
      background: linear-gradient(135deg, var(--success), #4ADDB4);
    }
    
    .confirmation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .confirmation-modal.active {
      display: flex;
    }
    
    .confirmation-content {
      background: white;
      border-radius: 24px;
      padding: 3rem 2rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: scaleIn 0.3s ease;
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--success), #4ADDB4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 3rem;
    }
    
    .booking-details {
      background: var(--background);
      padding: 1.5rem;
      border-radius: 16px;
      margin: 1.5rem 0;
      text-align: right;
      border: 2px solid var(--border);
    }
    
    .booking-details p {
      margin: 0.7rem 0;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>

<div class="medical-header">
  <h1>
    <span class="medical-icon" id="appIcon">ğŸ¥</span>
    <span id="appTitle">Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ©</span>
  </h1>
  <p id="appDescription">Ø§Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>
</div>

<div class="main-container">
  <div class="step active" id="step1">
    <h2>1ï¸âƒ£ Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
    
    <label>ğŸ©º Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
    <div id="doctorsContainer">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <label for="inputName">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
    <input type="text" id="inputName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">

    <label for="inputPhone">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
    <input type="tel" id="inputPhone" placeholder="Ù…Ø«Ø§Ù„: 01012345678">
    <div id="phoneError">âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ ØµÙØ±</div>

    <div class="button-group">
      <button id="toStep2Btn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ â†</button>
    </div>
  </div>

  <div class="step" id="step2">
    <h2>2ï¸âƒ£ Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…ÙˆØ¹Ø¯</h2>

    <label>ğŸ“… Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
    <div id="daysContainer">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <label>ğŸ• Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª:</label>
    <div id="timesContainer">ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹</div>

    <div class="button-group">
      <button id="backToStep1Btn">â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="confirmBookingBtn" disabled>âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
    </div>
  </div>
</div>

<div class="confirmation-modal" id="confirmationModal">
  <div class="confirmation-content">
    <div class="success-icon">âœ“</div>
    <h3>ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!</h3>
    <div class="booking-details" id="bookingDetails"></div>
    <button id="closeModalBtn">Ø­Ø³Ù†Ø§Ù‹</button>
  </div>
</div>

<script>
let selectedDoctor = null;
let selectedName = '';
let selectedPhone = '';
let selectedDay = null;
let selectedTime = null;
let slotsByDate = {};

function loadDoctors() {
  google.script.run
    .withSuccessHandler(function(doctors) {
      const container = document.getElementById('doctorsContainer');
      if (!doctors || doctors.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡</p>';
        return;
      }
      
      container.innerHTML = '';
      doctors.forEach(function(doc) {
        const btn = document.createElement('button');
        btn.textContent = doc.name;
        btn.onclick = function() { selectDoctor(this, doc.name); };
        container.appendChild(btn);
      });
    })
    .withFailureHandler(function(error) {
      document.getElementById('doctorsContainer').innerHTML = '<p style="text-align:center;color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
      console.error(error);
    })
    .getDoctors();
}

function selectDoctor(btn, doctorName) {
  selectedDoctor = doctorName;
  document.querySelectorAll('#doctorsContainer button').forEach(function(b) {
    b.classList.remove('selected');
  });
  btn.classList.add('selected');
  validateStep1();
}

function validatePhone() {
  const val = document.getElementById('inputPhone').value.trim();
  const regex = /^0\d{10}$/;
  const error = document.getElementById('phoneError');
  
  if (regex.test(val)) {
    error.style.display = 'none';
    selectedPhone = val;
    return true;
  } else if (val.length > 0) {
    error.style.display = 'block';
    return false;
  }
  error.style.display = 'none';
  return false;
}

function validateStep1() {
  selectedName = document.getElementById('inputName').value.trim();
  const valid = selectedDoctor && selectedName.length > 0 && validatePhone();
  document.getElementById('toStep2Btn').disabled = !valid;
}

document.getElementById('inputName').oninput = validateStep1;
document.getElementById('inputPhone').oninput = function() {
  validatePhone();
  validateStep1();
};

document.getElementById('toStep2Btn').onclick = function() {
  document.getElementById('step1').classList.remove('active');
  document.getElementById('step2').classList.add('active');
  loadAvailableSlots();
};

document.getElementById('backToStep1Btn').onclick = function() {
  document.getElementById('step2').classList.remove('active');
  document.getElementById('step1').classList.add('active');
};

function loadAvailableSlots() {
  const daysContainer = document.getElementById('daysContainer');
  const timesContainer = document.getElementById('timesContainer');
  daysContainer.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  timesContainer.textContent = 'ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹';
  
  google.script.run
    .withSuccessHandler(function(slots) {
      if (!slots || slots.length === 0) {
        daysContainer.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</p>';
        return;
      }
      
      slotsByDate = processSlots(slots);
      renderDays();
    })
    .withFailureHandler(function(error) {
      daysContainer.innerHTML = '<p style="text-align:center;color:red;">Ø®Ø·Ø£</p>';
      console.error(error);
    })
    .getAvailableSlotsForDoctor(selectedDoctor);
}

function processSlots(slotsArray) {
  const grouped = {};
  slotsArray.forEach(function(isoStr) {
    const date = new Date(isoStr);
    const dateKey = date.toISOString().split('T')[0];
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const timeString = hours + ':' + minutes;
    
    if (!grouped[dateKey]) grouped[dateKey] = [];
    grouped[dateKey].push({ time: timeString, isoString: isoStr });
  });
  
  Object.keys(grouped).forEach(function(k) {
    grouped[k].sort(function(a,b) { return a.time.localeCompare(b.time); });
  });
  
  return grouped;
}

function renderDays() {
  const container = document.getElementById('daysContainer');
  container.innerHTML = '';
  const dates = Object.keys(slotsByDate).sort();

  dates.forEach(function(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
    const dayNum = date.getDate();
    const monthName = date.toLocaleDateString('ar-EG', { month: 'long' });

    const btn = document.createElement('button');
    btn.textContent = dayName + '\n' + dayNum + ' ' + monthName;
    btn.onclick = function() { selectDay(dateStr, this); };
    container.appendChild(btn);
  });
}

function selectDay(dateStr, btn) {
  selectedDay = dateStr;
  selectedTime = null;
  document.getElementById('confirmBookingBtn').disabled = true;

  document.querySelectorAll('#daysContainer button').forEach(function(b) {
    b.classList.remove('selected');
  });
  btn.classList.add('selected');

  renderTimesForDay(dateStr);
}

function renderTimesForDay(dateStr) {
  const container = document.getElementById('timesContainer');
  container.innerHTML = '';
  const times = slotsByDate[dateStr] || [];

  times.forEach(function(slot) {
    const btn = document.createElement('button');
    btn.textContent = slot.time;
    btn.onclick = function() { selectTime(slot.time, this); };
    container.appendChild(btn);
  });
}

function selectTime(time, btn) {
  selectedTime = time;
  document.getElementById('confirmBookingBtn').disabled = false;

  document.querySelectorAll('#timesContainer button').forEach(function(b) {
    b.classList.remove('selected');
  });
  btn.classList.add('selected');
}

document.getElementById('confirmBookingBtn').onclick = function() {
  const appointmentISO = selectedDay + 'T' + selectedTime + ':00';

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showConfirmation();
      } else {
        alert('ÙØ´Ù„ Ø§Ù„Ø­Ø¬Ø²: ' + (result.message || 'Ø®Ø·Ø£'));
      }
    })
    .withFailureHandler(function(error) {
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
      console.error(error);
    })
    .bookAppointmentWithDoctor({
      doctorName: selectedDoctor,
      name: selectedName,
      phone: selectedPhone,
      appointmentTime: appointmentISO
    });
};

function showConfirmation() {
  const date = new Date(selectedDay + 'T00:00:00');
  const details = 
    '<p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> <span>Ø¯. ' + selectedDoctor + '</span></p>' +
    '<p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span>' + selectedName + '</span></p>' +
    '<p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span>' + selectedPhone + '</span></p>' +
    '<p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span>' + date.toLocaleDateString('ar-EG') + '</span></p>' +
    '<p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span>' + selectedTime + '</span></p>';
  
  document.getElementById('bookingDetails').innerHTML = details;
  document.getElementById('confirmationModal').classList.add('active');
}

document.getElementById('closeModalBtn').onclick = function() {
  document.getElementById('confirmationModal').classList.remove('active');
  
  selectedDoctor = null;
  selectedName = '';
  selectedPhone = '';
  document.getElementById('inputName').value = '';
  document.getElementById('inputPhone').value = '';
  
  document.getElementById('step2').classList.remove('active');
  document.getElementById('step1').classList.add('active');
  
  loadDoctors();
};

loadDoctors();
</script>

</body>
</html>
