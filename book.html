<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ</title>
  <style>
    :root {
      --primary: #00B4D8;
      --primary-light: #48CAE4;
      --primary-dark: #0096C7;
      --secondary: #90E0EF;
      --accent: #FF6B6B;
      --success: #06D6A0;
      --background: #CAF0F8;
      --card-bg: #FFFFFF;
      --text-primary: #023E8A;
      --text-secondary: #0077B6;
      --border: #ADE8F4;
      --shadow: rgba(0, 150, 199, 0.15);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      width: 100%;
      min-height: 100vh;
      font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #CAF0F8 0%, #90E0EF 100%);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    /* Header Ø§Ù„Ø·Ø¨ÙŠ */
    .medical-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      padding: 2rem 1rem;
      text-align: center;
      box-shadow: 0 4px 20px var(--shadow);
      margin-bottom: 2rem;
    }
    
    .medical-header h1 {
      color: white;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .medical-icon {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .medical-header p {
      color: rgba(255, 255, 255, 0.95);
      font-size: 1.1rem;
    }
    
    /* Container Ø±Ø¦ÙŠØ³ÙŠ */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem 3rem;
    }
    
    /* ØªØµÙ…ÙŠÙ… responsive Ù„Ù„Ø®Ø·ÙˆØ§Øª */
    .step {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 10px 40px var(--shadow);
      padding: 2.5rem 2rem;
      display: none;
      transition: all 0.3s ease;
      border: 3px solid var(--border);
    }
    
    .step.active {
      display: block;
      animation: slideIn 0.4s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 2rem;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .step-indicator {
      background: var(--primary-light);
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 600;
      font-size: 1.3rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    input[type="text"], input[type="tel"] {
      width: 100%;
      padding: 1.2rem 1.5rem;
      font-size: 1.4rem;
      border: 2px solid var(--border);
      border-radius: 16px;
      font-family: inherit;
      background: #E3F4F9;
      color: var(--text-primary);
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    
    input[type="text"]:focus, input[type="tel"]:focus {
      border-color: var(--primary);
      background: white;
      outline: none;
      box-shadow: 0 0 0 4px rgba(0, 180, 216, 0.1);
    }
    
    #phoneError {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 1rem;
      display: none;
      padding: 0.5rem 1rem;
      background: #FFEBEE;
      border-radius: 8px;
      border-right: 4px solid var(--accent);
    }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ */
    #doctorsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    #doctorsContainer button {
      background: linear-gradient(135deg, var(--secondary), var(--primary-light));
      padding: 1.2rem 1rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      border-radius: 16px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    #doctorsContainer button::before {
      content: 'ğŸ©º';
      display: block;
      font-size: 2.5rem;
      margin-bottom: 0.3rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    
    #doctorsContainer button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px var(--shadow);
    }
    
    #doctorsContainer button.selected {
      background: linear-gradient(135deg, var(--success), #4ADDB4);
      color: white;
      box-shadow: 0 8px 25px rgba(6, 214, 160, 0.4);
      transform: translateY(-3px);
    }
    
    #doctorsContainer button.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 8px;
      left: 8px;
      background: white;
      color: var(--success);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Øª */
    #daysContainer, #timesContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    #daysContainer button, #timesContainer button {
      background: linear-gradient(135deg, #B4E4F5, var(--secondary));
      padding: 1rem;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px var(--shadow);
    }
    
    #daysContainer button:hover, #timesContainer button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow);
    }
    
    #daysContainer button.selected, #timesContainer button.selected {
      background: linear-gradient(135deg, var(--success), #4ADDB4);
      color: white;
      border-color: var(--success);
      box-shadow: 0 6px 20px rgba(6, 214, 160, 0.4);
      transform: translateY(-2px);
    }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 2rem;
    }
    
    button {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      padding: 1.2rem 2.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      font-family: 'Cairo', sans-serif;
      box-shadow: 0 4px 15px var(--shadow);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px var(--shadow);
    }
    
    #backToStep1Btn {
      background: linear-gradient(135deg, #78909C, #90A4AE);
    }
    
    #confirmBookingBtn {
      background: linear-gradient(135deg, var(--success), #4ADDB4);
    }
    
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ */
    .confirmation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .confirmation-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .confirmation-content {
      background: white;
      border-radius: 24px;
      padding: 3rem 2rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: scaleIn 0.3s ease;
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--success), #4ADDB4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 3rem;
      animation: bounce 0.6s ease;
      box-shadow: 0 8px 20px rgba(6, 214, 160, 0.3);
    }
    
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .confirmation-content h3 {
      color: var(--primary);
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }
    
    .booking-details {
      background: var(--background);
      padding: 1.5rem;
      border-radius: 16px;
      margin: 1.5rem 0;
      text-align: right;
      border: 2px solid var(--border);
    }
    
    .booking-details p {
      margin: 0.7rem 0;
      font-size: 1.2rem;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .booking-details strong {
      color: var(--primary);
      font-weight: 700;
    }
    
    .close-modal-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      margin-top: 1rem;
    }
    
    .loading-indicator {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }
    
    .loading-indicator::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    /* Desktop Layout */
    @media (min-width: 768px) {
      .main-container {
        padding: 2rem;
      }
      
      .step {
        max-width: 900px;
        margin: 0 auto;
        padding: 3rem;
      }
      
      #doctorsContainer {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      
      #daysContainer, #timesContainer {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
    }
    
    @media (max-width: 767px) {
      .medical-header h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      .step {
        border-radius: 16px;
        padding: 1.5rem 1rem;
      }
    }
  </style>
</head>
<body>

<div class="medical-header">
  <h1>
    <span class="medical-icon" id="appIcon">ğŸ¥</span>
    <span id="appTitle">Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ©</span>
  </h1>
  <p id="appDescription">Ø§Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>
</div>

<div class="main-container">
  <!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 -->
  <div class="step active" id="step1">
    <h2>
      <span class="step-indicator">1</span>
      Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ
    </h2>
    
    <label>ğŸ©º Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
    <div id="doctorsContainer" class="loading-indicator">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>

    <label for="inputName">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
    <input type="text" id="inputName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name" />

    <label for="inputPhone">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
    <input type="tel" id="inputPhone" placeholder="Ù…Ø«Ø§Ù„: 01012345678" autocomplete="tel" />
    <div id="phoneError">âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ ØµÙØ±</div>

    <div class="button-group">
      <button id="toStep2Btn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ â†</button>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 -->
  <div class="step" id="step2">
    <h2>
      <span class="step-indicator">2</span>
      Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…ÙˆØ¹Ø¯
    </h2>

    <label>ğŸ“… Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
    <div id="daysContainer" class="loading-indicator">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>

    <label>ğŸ• Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨:</label>
    <div id="timesContainer">ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹</div>

    <div class="button-group">
      <button id="backToStep1Btn">â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="confirmBookingBtn" disabled>âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
<div class="confirmation-modal" id="confirmationModal">
  <div class="confirmation-content">
    <div class="success-icon">âœ“</div>
    <h3>ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">ØªÙ… ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ø·Ø¨ÙŠ</p>
    
    <div class="booking-details" id="bookingDetails"></div>
    
    <button class="close-modal-btn" onclick="closeConfirmation()">Ø­Ø³Ù†Ø§Ù‹</button>
  </div>
</div>

<script>
const BASE_URL = 'https://script.google.com/macros/s/AKfycbwSbETIi5LMZe8LTLSRDKxp8ovjOWGX3cWMYIj9kAInkps9G4qFH7hofhtn1o0fANf4/exec';

let selectedDoctor = null;
let selectedName = '';
let selectedPhone = '';
let selectedDay = null;
let selectedTime = null;
let slotsByDate = {};
let settingsCache = null;
let doctorsCache = null;

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
async function loadSettings() {
  if (settingsCache) return settingsCache;
  
  try {
    const res = await fetch(BASE_URL + '?action=getSettings', {
      method: 'GET',
      cache: 'force-cache'
    });
    settingsCache = await res.json();
    applySettings(settingsCache);
    return settingsCache;
  } catch(e) {
    console.error('Error loading settings:', e);
    return {};
  }
}

function applySettings(settings) {
  const appTitle = document.getElementById('appTitle');
  const appDescription = document.getElementById('appDescription');
  const appIcon = document.getElementById('appIcon');
  
  if (settings['Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†']) {
    appTitle.textContent = settings['Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†'];
    document.title = settings['Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†'];
  }
  
  if (settings['Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø©']) {
    appDescription.textContent = settings['Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø©'];
  }
  
  if (settings['Ø§Ù„Ù„ÙˆØ¬Ùˆ']) {
    appIcon.textContent = settings['Ø§Ù„Ù„ÙˆØ¬Ùˆ'];
  }
}

async function loadDoctors() {
  const container = document.getElementById('doctorsContainer');
  
  try {
    const res = await fetch(BASE_URL + '?action=getDoctors', {
      method: 'GET',
      cache: 'default'
    });
    const doctors = await res.json();
    doctorsCache = doctors;
    
    if (!doctors || doctors.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
      return;
    }
    
    container.innerHTML = '';
    doctors.forEach(doc => {
      const docName = typeof doc === 'string' ? doc : doc.name;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = docName;
      btn.onclick = () => selectDoctor(btn, docName);
      container.appendChild(btn);
    });
  } catch(e) {
    console.error('Error loading doctors:', e);
    container.innerHTML = '<p style="text-align:center;color:#999;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>';
  }
}

function selectDoctor(btn, doctorName) {
  selectedDoctor = doctorName;
  document.querySelectorAll('#doctorsContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  validateStep1();
}

const phoneInput = document.getElementById('inputPhone');
const phoneError = document.getElementById('phoneError');

function validatePhone() {
  const val = phoneInput.value.trim();
  const regex = /^0\d{10}$/;
  if (regex.test(val)) {
    phoneError.style.display = 'none';
    selectedPhone = val;
    return true;
  } else if (val.length > 0) {
    phoneError.style.display = 'block';
    selectedPhone = '';
    return false;
  } else {
    phoneError.style.display = 'none';
    selectedPhone = '';
    return false;
  }
}

phoneInput.addEventListener('input', () => {
  validatePhone();
  validateStep1();
});

function validateStep1() {
  selectedName = document.getElementById('inputName').value.trim();
  const valid = selectedDoctor && selectedName.length > 0 && validatePhone();
  document.getElementById('toStep2Btn').disabled = !valid;
}

document.getElementById('inputName').addEventListener('input', validateStep1);

document.getElementById('toStep2Btn').addEventListener('click', () => {
  if (!selectedDoctor || !selectedName || !selectedPhone) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.');
    return;
  }
  document.getElementById('step1').classList.remove('active');
  document.getElementById('step2').classList.add('active');
  loadAvailableSlots(selectedDoctor);
});

document.getElementById('backToStep1Btn').addEventListener('click', () => {
  document.getElementById('step2').classList.remove('active');
  document.getElementById('step1').classList.add('active');
});

async function loadAvailableSlots(doctorName) {
  const daysContainer = document.getElementById('daysContainer');
  const timesContainer = document.getElementById('timesContainer');
  daysContainer.className = 'loading-indicator';
  daysContainer.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯';
  timesContainer.textContent = 'ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹';
  selectedDay = null;
  selectedTime = null;
  document.getElementById('confirmBookingBtn').disabled = true;

  try {
    const res = await fetch(BASE_URL + `?action=getAvailableSlotsForDoctor&doctorName=${encodeURIComponent(doctorName)}`, {
      method: 'GET',
      cache: 'no-cache'
    });
    const slots = await res.json();

    if (!slots || slots.length === 0) {
      daysContainer.className = '';
      daysContainer.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
      timesContainer.innerHTML = '';
      return;
    }

    slotsByDate = processSlots(slots);
    renderDays();
  } catch(e) {
    console.error('Error loading slots:', e);
    daysContainer.className = '';
    daysContainer.innerHTML = '<p style="text-align:center;color:#999;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯.</p>';
    timesContainer.innerHTML = '';
  }
}

function processSlots(slotsArray) {
  const grouped = {};
  slotsArray.forEach(isoStr => {
    try {
      const date = new Date(isoStr);
      const dateKey = date.toISOString().split('T')[0];
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}`;
      if (!grouped[dateKey]) grouped[dateKey] = [];
      grouped[dateKey].push({ time: timeString, isoString: isoStr });
    } catch(e) {}
  });
  Object.keys(grouped).forEach(k => grouped[k].sort((a,b) => a.time.localeCompare(b.time)));
  return grouped;
}

function renderDays() {
  const container = document.getElementById('daysContainer');
  container.className = '';
  container.innerHTML = '';
  const dates = Object.keys(slotsByDate).sort();

  dates.forEach(dateStr => {
    const date = new Date(dateStr + 'T00:00:00');
    const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
    const dayNum = date.getDate();
    const monthName = date.toLocaleDateString('ar-EG', { month: 'long' });

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = `${dayName}\n${dayNum} ${monthName}`;
    btn.onclick = () => selectDay(dateStr, btn);
    container.appendChild(btn);
  });
  document.getElementById('timesContainer').textContent = 'ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹';
}

function selectDay(dateStr, btn) {
  selectedDay = dateStr;
  selectedTime = null;
  document.getElementById('confirmBookingBtn').disabled = true;

  document.querySelectorAll('#daysContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  renderTimesForDay(dateStr);
}

function renderTimesForDay(dateStr) {
  const container = document.getElementById('timesContainer');
  container.innerHTML = '';
  const times = slotsByDate[dateStr] || [];

  if (!times.length) {
    container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª Ù…ØªØ§Ø­Ø©</p>';
    return;
  }

  times.forEach(slot => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = slot.time;
    btn.addEventListener('click', function() {
      selectTime(slot.time, this);
    });
    container.appendChild(btn);
  });
}

function selectTime(time, btn) {
  selectedTime = time;
  document.getElementById('confirmBookingBtn').disabled = false;

  document.querySelectorAll('#timesContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

document.getElementById('confirmBookingBtn').addEventListener('click', async function() {
  if (!selectedTime || !selectedDay || !selectedDoctor || !selectedName || !selectedPhone) {
    alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¹Ø¯');
    return;
  }

  const appointmentISO = `${selectedDay}T${selectedTime}:00`;

  const formData = new URLSearchParams();
  formData.append('action', 'bookAppointmentWithDoctor');
  formData.append('doctorName', selectedDoctor);
  formData.append('name', selectedName);
  formData.append('phone', selectedPhone);
  formData.append('appointmentTime', appointmentISO);

  try {
    const res = await fetch(BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData.toString()
    });
    const result = await res.json();
    if (result.success) {
      showConfirmation();
    } else {
      alert('ÙØ´Ù„ Ø§Ù„Ø­Ø¬Ø²: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }
  } catch(e) {
    console.error('Booking error:', e);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
  }
});

function showConfirmation() {
  const date = new Date(selectedDay + 'T00:00:00');
  const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
  const dayNum = date.getDate();
  const monthName = date.toLocaleDateString('ar-EG', { month: 'long' });
  const year = date.getFullYear();
  
  const details = `
    <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> <span>Ø¯. ${selectedDoctor}</span></p>
    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span>${selectedName}</span></p>
    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span>${selectedPhone}</span></p>
    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span>${dayName} ${dayNum} ${monthName} ${year}</span></p>
    <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span>${selectedTime}</span></p>
  `;
  
  document.getElementById('bookingDetails').innerHTML = details;
  document.getElementById('confirmationModal').classList.add('active');
}

function closeConfirmation() {
  <!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ</title>
  <style>
    :root {
      --primary: #00897B;
      --primary-light: #4DB6AC;
      --primary-dark: #00695C;
      --secondary: #26A69A;
      --accent: #FF5252;
      --success: #66BB6A;
      --background: #E8F5E9;
      --card-bg: #FFFFFF;
      --text-primary: #1B5E20;
      --text-secondary: #558B2F;
      --border: #C8E6C9;
      --shadow: rgba(0, 105, 92, 0.15);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      width: 100%;
      min-height: 100vh;
      font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #E8F5E9 0%, #B9F6CA 100%);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    /* Header Ø§Ù„Ø·Ø¨ÙŠ */
    .medical-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      padding: 2rem 1rem;
      text-align: center;
      box-shadow: 0 4px 20px var(--shadow);
      margin-bottom: 2rem;
    }
    
    .medical-header h1 {
      color: white;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .medical-icon {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .medical-header p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.1rem;
    }
    
    /* Container Ø±Ø¦ÙŠØ³ÙŠ */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem 3rem;
    }
    
    /* ØªØµÙ…ÙŠÙ… responsive Ù„Ù„Ø®Ø·ÙˆØ§Øª */
    .step {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 10px 40px var(--shadow);
      padding: 2.5rem 2rem;
      display: none;
      transition: all 0.3s ease;
      border: 3px solid var(--border);
    }
    
    .step.active {
      display: block;
      animation: slideIn 0.4s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 2rem;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .step-indicator {
      background: var(--primary-light);
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 600;
      font-size: 1.3rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    input[type="text"], input[type="tel"] {
      width: 100%;
      padding: 1.2rem 1.5rem;
      font-size: 1.4rem;
      border: 2px solid var(--border);
      border-radius: 16px;
      font-family: inherit;
      background: #F1F8E9;
      color: var(--text-primary);
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    
    input[type="text"]:focus, input[type="tel"]:focus {
      border-color: var(--primary);
      background: white;
      outline: none;
      box-shadow: 0 0 0 4px rgba(0, 137, 123, 0.1);
    }
    
    #phoneError {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 1rem;
      display: none;
      padding: 0.5rem 1rem;
      background: #FFEBEE;
      border-radius: 8px;
      border-right: 4px solid var(--accent);
    }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ */
    #doctorsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    #doctorsContainer button {
      background: linear-gradient(135deg, var(--secondary), var(--primary-light));
      padding: 1.2rem 1rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    #doctorsContainer button::before {
      content: 'ğŸ‘¨â€âš•ï¸';
      display: block;
      font-size: 2rem;
      margin-bottom: 0.3rem;
    }
    
    #doctorsContainer button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px var(--shadow);
    }
    
    #doctorsContainer button.selected {
      background: linear-gradient(135deg, var(--success), #81C784);
      box-shadow: 0 8px 25px rgba(102, 187, 106, 0.4);
      transform: translateY(-3px);
    }
    
    #doctorsContainer button.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 5px;
      left: 5px;
      background: white;
      color: var(--success);
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: bold;
    }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Øª */
    #daysContainer, #timesContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    #daysContainer button, #timesContainer button {
      background: linear-gradient(135deg, #B2DFDB, var(--secondary));
      padding: 1rem;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px var(--shadow);
    }
    
    #daysContainer button:hover, #timesContainer button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow);
    }
    
    #daysContainer button.selected, #timesContainer button.selected {
      background: linear-gradient(135deg, var(--success), #81C784);
      color: white;
      border-color: var(--success);
      box-shadow: 0 6px 20px rgba(102, 187, 106, 0.4);
      transform: translateY(-2px);
    }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 2rem;
    }
    
    button {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      padding: 1.2rem 2.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      font-family: 'Cairo', sans-serif;
      box-shadow: 0 4px 15px var(--shadow);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px var(--shadow);
    }
    
    #backToStep1Btn {
      background: linear-gradient(135deg, #78909C, #90A4AE);
    }
    
    #confirmBookingBtn {
      background: linear-gradient(135deg, var(--success), #81C784);
    }
    
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ */
    .confirmation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .confirmation-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .confirmation-content {
      background: white;
      border-radius: 24px;
      padding: 3rem 2rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: scaleIn 0.3s ease;
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--success), #81C784);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 3rem;
      animation: bounce 0.6s ease;
    }
    
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .confirmation-content h3 {
      color: var(--primary);
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }
    
    .booking-details {
      background: var(--background);
      padding: 1.5rem;
      border-radius: 16px;
      margin: 1.5rem 0;
      text-align: right;
      border: 2px solid var(--border);
    }
    
    .booking-details p {
      margin: 0.7rem 0;
      font-size: 1.2rem;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .booking-details strong {
      color: var(--primary);
      font-weight: 700;
    }
    
    .close-modal-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      margin-top: 1rem;
    }
    
    /* Desktop Layout */
    @media (min-width: 768px) {
      .main-container {
        padding: 2rem;
      }
      
      .step {
        max-width: 900px;
        margin: 0 auto;
        padding: 3rem;
      }
      
      #doctorsContainer {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      
      #daysContainer, #timesContainer {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
    }
    
    @media (max-width: 767px) {
      .medical-header h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      .step {
        border-radius: 16px;
        padding: 1.5rem 1rem;
      }
    }
  </style>
</head>
<body>

<div class="medical-header">
  <h1>
    <span class="medical-icon">ğŸ¥</span>
    Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ©
  </h1>
  <p>Ø§Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯Ùƒ Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>
</div>

<div class="main-container">
  <!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 -->
  <div class="step active" id="step1">
    <h2>
      <span class="step-indicator">1</span>
      Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ
    </h2>
    
    <label>ğŸ‘¨â€âš•ï¸ Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
    <div id="doctorsContainer">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <label for="inputName">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
    <input type="text" id="inputName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name" />

    <label for="inputPhone">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
    <input type="tel" id="inputPhone" placeholder="Ù…Ø«Ø§Ù„: 01012345678" autocomplete="tel" />
    <div id="phoneError">âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ ØµÙØ±</div>

    <div class="button-group">
      <button id="toStep2Btn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ â†</button>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 -->
  <div class="step" id="step2">
    <h2>
      <span class="step-indicator">2</span>
      Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…ÙˆØ¹Ø¯
    </h2>

    <label>ğŸ“… Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
    <div id="daysContainer">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <label>ğŸ• Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨:</label>
    <div id="timesContainer">ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹</div>

    <div class="button-group">
      <button id="backToStep1Btn">â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="confirmBookingBtn" disabled>âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
<div class="confirmation-modal" id="confirmationModal">
  <div class="confirmation-content">
    <div class="success-icon">âœ“</div>
    <h3>ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">ØªÙ… ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ø·Ø¨ÙŠ</p>
    
    <div class="booking-details" id="bookingDetails"></div>
    
    <button class="close-modal-btn" onclick="closeConfirmation()">Ø­Ø³Ù†Ø§Ù‹</button>
  </div>
</div>

<script>
const BASE_URL = 'https://script.google.com/macros/s/AKfycbxduonFydVRyBGbAPUU6zyBtOc8zF_pGCBv4WBj0aUP7NMwpTrrQtV-rNvSSp8-qO9S/exec';

let selectedDoctor = null;
let selectedName = '';
let selectedPhone = '';
let selectedDay = null;
let selectedTime = null;
let slotsByDate = {};

async function loadDoctors() {
  try {
    const res = await fetch(BASE_URL + '?action=getDoctors');
    const data = await res.json();
    
    console.log('Doctors response:', data); // Ù„Ù„ØªØµØ­ÙŠØ­
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØµÙŠØº Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    let doctors = [];
    if (Array.isArray(data)) {
      doctors = data;
    } else if (data.success && Array.isArray(data.doctors)) {
      doctors = data.doctors;
    } else if (data.success && Array.isArray(data.data)) {
      doctors = data.data;
    }
    
    const container = document.getElementById('doctorsContainer');
    
    if (!doctors || doctors.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
      return;
    }
    
    container.innerHTML = '';
    doctors.forEach(doc => {
      const docName = typeof doc === 'string' ? doc : (doc.name || doc.Ø§Ø³Ù… || '');
      if (docName) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = docName;
        btn.onclick = () => selectDoctor(btn, docName);
        container.appendChild(btn);
      }
    });
  } catch(e) {
    console.error('Load doctors error:', e);
    document.getElementById('doctorsContainer').innerHTML = '<p style="text-align:center;color:#999;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>';
  }
}

function selectDoctor(btn, doctorName) {
  selectedDoctor = doctorName;
  document.querySelectorAll('#doctorsContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  validateStep1();
}

const phoneInput = document.getElementById('inputPhone');
const phoneError = document.getElementById('phoneError');

function validatePhone() {
  const val = phoneInput.value.trim();
  const regex = /^0\d{10}$/;
  if (regex.test(val)) {
    phoneError.style.display = 'none';
    selectedPhone = val;
    return true;
  } else if (val.length > 0) {
    phoneError.style.display = 'block';
    selectedPhone = '';
    return false;
  } else {
    phoneError.style.display = 'none';
    selectedPhone = '';
    return false;
  }
}

phoneInput.addEventListener('input', () => {
  validatePhone();
  validateStep1();
});

function validateStep1() {
  selectedName = document.getElementById('inputName').value.trim();
  const valid = selectedDoctor && selectedName.length > 0 && validatePhone();
  document.getElementById('toStep2Btn').disabled = !valid;
}

document.getElementById('inputName').addEventListener('input', validateStep1);

document.getElementById('toStep2Btn').addEventListener('click', () => {
  if (!selectedDoctor || !selectedName || !selectedPhone) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.');
    return;
  }
  document.getElementById('step1').classList.remove('active');
  document.getElementById('step2').classList.add('active');
  loadAvailableSlots(selectedDoctor);
});

document.getElementById('backToStep1Btn').addEventListener('click', () => {
  document.getElementById('step2').classList.remove('active');
  document.getElementById('step1').classList.add('active');
});

async function loadAvailableSlots(doctorName) {
  const daysContainer = document.getElementById('daysContainer');
  const timesContainer = document.getElementById('timesContainer');
  daysContainer.textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯...';
  timesContainer.textContent = 'ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹';
  selectedDay = null;
  selectedTime = null;
  document.getElementById('confirmBookingBtn').disabled = true;

  try {
    const res = await fetch(BASE_URL + `?action=getAvailableSlotsForDoctor&doctorName=${encodeURIComponent(doctorName)}`);
    const data = await res.json();
    
    console.log('Slots response:', data); // Ù„Ù„ØªØµØ­ÙŠØ­
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØµÙŠØº Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    let slots = [];
    if (Array.isArray(data)) {
      slots = data;
    } else if (data.success && Array.isArray(data.slots)) {
      slots = data.slots;
    } else if (data.success && Array.isArray(data.data)) {
      slots = data.data;
    }

    if (!slots || slots.length === 0) {
      daysContainer.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
      timesContainer.innerHTML = '';
      return;
    }

    slotsByDate = processSlots(slots);
    renderDays();
  } catch(e) {
    console.error('Load slots error:', e);
    daysContainer.innerHTML = '<p style="text-align:center;color:#999;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯.</p>';
    timesContainer.innerHTML = '';
  }
}

function processSlots(slotsArray) {
  const grouped = {};
  slotsArray.forEach(isoStr => {
    try {
      const date = new Date(isoStr);
      const dateKey = date.toISOString().split('T')[0];
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}`;
      if (!grouped[dateKey]) grouped[dateKey] = [];
      grouped[dateKey].push({ time: timeString, isoString: isoStr });
    } catch(e) {}
  });
  Object.keys(grouped).forEach(k => grouped[k].sort((a,b) => a.time.localeCompare(b.time)));
  return grouped;
}

function renderDays() {
  const container = document.getElementById('daysContainer');
  container.innerHTML = '';
  const dates = Object.keys(slotsByDate).sort();

  dates.forEach(dateStr => {
    const date = new Date(dateStr + 'T00:00:00');
    const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
    const dayNum = date.getDate();
    const monthName = date.toLocaleDateString('ar-EG', { month: 'long' });

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = `${dayName}\n${dayNum} ${monthName}`;
    btn.addEventListener('click', function() {
      selectDay(dateStr, this);
    });
    container.appendChild(btn);
  });
  document.getElementById('timesContainer').textContent = 'ÙŠÙØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹';
}

function selectDay(dateStr, btn) {
  selectedDay = dateStr;
  selectedTime = null;
  document.getElementById('confirmBookingBtn').disabled = true;

  document.querySelectorAll('#daysContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  renderTimesForDay(dateStr);
}

function renderTimesForDay(dateStr) {
  const container = document.getElementById('timesContainer');
  container.innerHTML = '';
  const times = slotsByDate[dateStr] || [];

  if (!times.length) {
    container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª Ù…ØªØ§Ø­Ø©</p>';
    return;
  }

  times.forEach(slot => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = slot.time;
    btn.onclick = () => selectTime(slot.time, btn);
    container.appendChild(btn);
  });
}

function selectTime(time, btn) {
  selectedTime = time;
  document.getElementById('confirmBookingBtn').disabled = false;

  document.querySelectorAll('#timesContainer button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

document.getElementById('confirmBookingBtn').addEventListener('click', async () => {
  if (!selectedTime || !selectedDay || !selectedDoctor || !selectedName || !selectedPhone) {
    alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¹Ø¯');
    return;
  }

  const appointmentISO = `${selectedDay}T${selectedTime}:00`;

  const formData = new URLSearchParams();
  formData.append('action', 'bookAppointmentWithDoctor');
  formData.append('doctorName', selectedDoctor);
  formData.append('name', selectedName);
  formData.append('phone', selectedPhone);
  formData.append('appointmentTime', appointmentISO);

  try {
    const res = await fetch(BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData.toString()
    });
    const result = await res.json();
    if (result.success) {
      showConfirmation();
    } else {
      alert('ÙØ´Ù„ Ø§Ù„Ø­Ø¬Ø²: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }
  } catch(e) {
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
  }
});

function showConfirmation() {
  const date = new Date(selectedDay + 'T00:00:00');
  const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
  const dayNum = date.getDate();
  const monthName = date.toLocaleDateString('ar-EG', { month: 'long' });
  const year = date.getFullYear();
  
  const details = `
    <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> <span>Ø¯. ${selectedDoctor}</span></p>
    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span>${selectedName}</span></p>
    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span>${selectedPhone}</span></p>
    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span>${dayName} ${dayNum} ${monthName} ${year}</span></p>
    <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span>${selectedTime}</span></p>
  `;
  
  document.getElementById('bookingDetails').innerHTML = details;
  document.getElementById('confirmationModal').classList.add('active');
}

function closeConfirmation() {
  document.getElementById('confirmationModal').classList.remove('active');
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…
  selectedDoctor = null;
  selectedName = '';
  selectedPhone = '';
  selectedDay = null;
  selectedTime = null;
  slotsByDate = {};

  document.getElementById('inputName').value = '';
  document.getElementById('inputPhone').value = '';
  phoneError.style.display = 'none';
  document.querySelectorAll('#doctorsContainer button').forEach(b => b.classList.remove('selected'));
  document.getElementById('daysContainer').innerHTML = '';
  document.getElementById('timesContainer').innerHTML = '';
  document.getElementById('confirmBookingBtn').disabled = true;
  document.getElementById('toStep2Btn').disabled = true;

  document.getElementById('step2').classList.remove('active');
  document.getElementById('step1').classList.add('active');
  
  loadDoctors();
}
</script>

</body>
</html>
